#requires -RunAsAdministrator
function Import-PSGalleryModule {
  [CmdletBinding()]
  param (
    [Parameter(Mandatory, ValueFromPipeline)]
    [string]
    $Name
  )

  process {
    try {
      Import-Module -Name $Name -ErrorAction Stop
    }
    catch {
      $lookup = Find-Module -Name $Name
      if (-not $lookup) {
        Write-Error "Module `"$Name`" not found."
        continue
      }
      Install-Module -Name $Name -Scope CurrentUser -Force
      Import-Module -Name $Name
    }
  }
}

function Get-GitFile {
  [CmdletBinding()]
  param (
    [Parameter(Mandatory, ValueFromPipeline)]
    [ValidatePattern('https://raw\.githubusercontent\.com.*')]
    [string]
    $URL
  )

  process {
    return (Invoke-WebRequest -Uri $URL).Content
  }
}

function Initialize-Profile {
  [CmdletBinding()]
  param ()

  process {
    if (-not (Test-Path $profile)) {
      New-Item $profile -Value "# Empty Profile"
    }
  }
}
$psgallery_modules = [System.Collections.Generic.List[string]]::new()
# PowerShell Development Modules
('Pester', 'Plaster', 'psake', 'platyPS', 'PowerShellBuild', 'Stucco') | ForEach-Object { $psgallery_modules.Add($_) }
# PowerShell Commandline Quality of Life Modules
('posh-git', 'oh-my-posh', 'Get-ChildItemColor') | ForEach-Object { $psgallery_modules.Add($_) }
if (-not (Get-Module 'PSReadline')) {$psgallery_modules.Add('PSReadline')}

$git_ps_profile_url = 'https://raw.githubusercontent.com/bamsammich/PowerShell/master/Profile/Profile.ps1'
$git_ps_theme_url = 'https://raw.githubusercontent.com/bamsammich/PowerShell/master/Themes/Paradox_custom.psm1'

# Ensure Profile used by this session exists
Initialize-Profile

# Import defined PSGallery Modules
$psgallery_modules | Import-PSGalleryModule

# Set Theme
$theme_name = ($git_ps_theme_url -split '/' | Select-Object -Last 1).Trim()
$local_theme = Get-ChildItem $ThemeSettings.MyThemesLocation | Where-Object { $_.Name -eq $theme_name } | Get-Content
$git_theme = Get-GitFile $git_ps_theme_url
if ($local_theme -ne $git_theme) {
  Write-Information "Updating local theme content from github."
  $git_theme | Out-File "$($ThemeSettings.MyThemesLocation)\$theme_name" -Force
}
Set-Theme (Get-Item "$($ThemeSettings.MyThemesLocation)\$theme_name").BaseName

# Update local profile from github repo (if current does not match)
$git_ps_profile = Get-GitFile $git_ps_profile_url
$local_profile = Get-Content $profile -Raw
if ($local_profile -ne $git_ps_profile) {
  Write-Information "Updating local profile from github."
  $git_ps_profile | Out-File $profile -Force
}
